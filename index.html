<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Load Master - Truck Calculator</title>
    
    <link href="https://unpkg.com/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* --- CUSTOM COMPATIBILITY STYLES --- */
        /* These ensure the colors look right without the heavy script */
        
        :root {
            --orange-50: #fff7ed;
            --orange-100: #ffedd5;
            --orange-200: #fed7aa;
            --orange-500: #f97316;
            --orange-600: #ea580c;
            --orange-700: #c2410c;
            --orange-800: #9a3412;
        }

        /* Orange Color Map */
        .bg-orange-50 { background-color: var(--orange-50); }
        .bg-orange-100 { background-color: var(--orange-100); }
        .bg-orange-500 { background-color: var(--orange-500); }
        .bg-orange-600 { background-color: var(--orange-600); }
        .bg-orange-700 { background-color: var(--orange-700); }
        
        .text-orange-100 { color: var(--orange-100); }
        .text-orange-600 { color: var(--orange-600); }
        .text-orange-800 { color: var(--orange-800); }
        
        .border-orange-200 { border-color: var(--orange-200); }
        .border-orange-500 { border-color: var(--orange-500); }
        
        .hover\:bg-orange-700:hover { background-color: var(--orange-700); }
        .hover\:border-orange-500:hover { border-color: var(--orange-500); }

        /* Animation Keyframes */
        @keyframes loading-bar {
            0% { width: 0%; }
            100% { width: 100%; }
        }
        .animate-loading-bar {
            animation: loading-bar 2.4s ease-in-out forwards;
        }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.5s ease-out forwards;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(-25%); animation-timing-function: cubic-bezier(0.8, 0, 1, 1); }
            50% { transform: translateY(0); animation-timing-function: cubic-bezier(0, 0, 0.2, 1); }
        }
        .animate-bounce {
            animation: bounce 1s infinite;
        }

        /* Toggle Switch Styling */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #f97316;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #f97316;
        }
        .toggle-checkbox:checked + .toggle-label .dot {
            transform: translateX(100%);
        }
        
        /* Utility overrides for older browsers */
        .hidden { display: none !important; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800 min-h-screen flex flex-col">

    <div id="splash-screen" class="fixed inset-0 bg-orange-500 flex flex-col items-center justify-center z-50 text-white">
        <div class="animate-bounce mb-6">
            <i data-lucide="truck" width="100" height="100" stroke-width="1.5"></i>
        </div>
        <h1 class="text-4xl font-bold tracking-wider mb-2">LOAD MASTER</h1>
        <div class="w-48 h-2 bg-orange-700 rounded-full overflow-hidden">
            <div class="h-full bg-white animate-loading-bar"></div>
        </div>
        <p class="mt-4 text-orange-100 font-light">Calibrating Dimensions...</p>
    </div>

    <header class="bg-orange-500 text-white p-4 shadow-lg sticky top-0 z-20" id="main-header" style="display:none;">
        <div class="max-w-3xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-2">
                <i data-lucide="truck" width="24" height="24"></i>
                <h1 class="text-lg font-bold tracking-wide">LOAD MASTER</h1>
            </div>
            <button id="btn-header-reset" onclick="handleNewPlan()" class="text-xs bg-orange-600 hover:bg-orange-700 px-3 py-1 rounded-full flex items-center gap-1 transition-colors hidden">
                <i data-lucide="refresh-cw" width="12" height="12"></i> New Plan
            </button>
        </div>
    </header>

    <main class="max-w-3xl mx-auto p-4 md:p-6 flex-grow w-full" id="app-content" style="display:none;">
        </main>

    <script>
        // --- DATA ---
        // UPDATED DIMENSIONS: Calculated as Feet * 30 = CM
        const TRUCK_TYPES = [
            // Mini Trucks (Approx feet conversion)
            { id: 10, name: 'Tata Ace (Chhota Hathi)', l: 210, w: 150, h: 150, maxWeight: 750, icon: 'ðŸ˜', desc: 'Mini Truck (7ft)' },
            { id: 11, name: 'Dost / Small LCV', l: 240, w: 162, h: 165, maxWeight: 1250, icon: 'ðŸšš', desc: 'Ashok Leyland Dost (8ft)' },
            { id: 12, name: 'Bada Dost / Medium LCV', l: 300, w: 175, h: 175, maxWeight: 1850, icon: 'ðŸš›', desc: 'i3/i4 Goods transport (10ft)' },
            
            // Commercial Containers (Explicit Feet * 30)
            { id: 13, name: '12ft Box Truck', l: 360, w: 200, h: 200, maxWeight: 2500, icon: 'ðŸ“¦', desc: 'Standard 12ft container' },
            { id: 14, name: '14ft Box Truck', l: 420, w: 210, h: 210, maxWeight: 3500, icon: 'ðŸ“¦', desc: 'Standard 14ft container' },
            { id: 15, name: '17ft Box Truck', l: 510, w: 220, h: 220, maxWeight: 5000, icon: 'ðŸ“¦', desc: 'Medium Cargo (17ft)' },
            
            // 20ft (20 * 30 = 600)
            { id: 20, name: '20ft Container Truck', l: 600, w: 240, h: 240, maxWeight: 7000, icon: 'ðŸ‡®ðŸ‡³', desc: 'Standard Indian 20ft' },
            
            // Large Trucks
            { id: 16, name: '22ft Box Truck', l: 660, w: 240, h: 240, maxWeight: 10000, icon: 'ðŸ—ï¸', desc: 'Heavy Cargo / Container' },
            { id: 17, name: '24ft Box Truck', l: 720, w: 240, h: 240, maxWeight: 12000, icon: 'ðŸ—ï¸', desc: 'Full-sized large container' },
            { id: 18, name: '32ft Container', l: 960, w: 240, h: 240, maxWeight: 15000, icon: 'ðŸš¢', desc: 'High-capacity SXL/MXL' },
        ];

        // --- STATE ---
        let state = {
            step: 1,
            selectedTruck: null,
            boxManifest: [],
            currentBox: { name: '', l: '', w: '', h: '', weight: '', qty: 1, stackable: true },
            customTruck: { name: 'Custom Truck', l: '', w: '', h: '', maxWeight: '' }
        };

        // --- INITIALIZATION ---
        window.onload = function() {
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }
            setTimeout(() => {
                document.getElementById('splash-screen').style.display = 'none';
                document.getElementById('main-header').style.display = 'block';
                document.getElementById('app-content').style.display = 'block';
                render();
            }, 2500);
        };

        // --- CALCULATION LOGIC ---

        function calculateGeometricMax(truck, box) {
            if (!truck || !box.l || !box.w || !box.h) return 0;
            
            const T = [parseFloat(truck.l), parseFloat(truck.w), parseFloat(truck.h)];
            const B = [parseFloat(box.l), parseFloat(box.w), parseFloat(box.h)];
            
            if (B.some(d => d <= 0) || B[2] > T[2]) return 0; // Height constraint must always be respected

            let weightLimitCount = Infinity;
            if (box.weight && box.weight > 0 && truck.maxWeight) {
                weightLimitCount = Math.floor(parseFloat(truck.maxWeight) / parseFloat(box.weight));
            }

            const getGridCount = (t, b) => Math.floor(t[0] / b[0]) * Math.floor(t[1] / b[1]) * Math.floor(t[2] / b[2]);
            
            // Allow all 6 rotations for geometric search
            const orientations = [
                [B[0], B[1], B[2]], [B[0], B[2], B[1]],
                [B[1], B[0], B[2]], [B[1], B[2], B[0]],
                [B[2], B[0], B[1]], [B[2], B[1], B[0]],
            ];

            let maxCount = 0;
            if (box.stackable === false) {
                // Only 2D floor area allowed if non-stackable
                maxCount = Math.max(
                    Math.floor(T[0] / B[0]) * Math.floor(T[1] / B[1]),
                    Math.floor(T[0] / B[1]) * Math.floor(T[1] / B[0])
                );
            } else {
                orientations.forEach(o => {
                    if (o[2] <= T[2]) { // Check height again per orientation
                        const count = getGridCount(T, o);
                        if (count > maxCount) maxCount = count;
                    }
                });
            }

            return Math.min(maxCount, weightLimitCount);
        }

        function calculateLoadStatus(truck, manifest) {
            if (!truck || manifest.length === 0) return { fits: true, percentVol: 0, percentWeight: 0, msg: "Empty Load", reason: "", estimatedFit: 0, totalWeight: 0, totalBoxes: 0 };

            let totalWeight = 0;
            let totalRequestedBoxes = 0;
            
            manifest.forEach(item => {
                const qty = parseFloat(item.qty) || 0;
                const weight = parseFloat(item.weight) || 0;
                totalRequestedBoxes += qty;
                totalWeight += weight * qty;
            });

            const percentWeight = (totalWeight / parseFloat(truck.maxWeight)) * 100;
            const firstItem = manifest[0];
            const isUniformLoad = manifest.length === 1 || manifest.every(item => 
                item.l === firstItem.l && item.w === firstItem.w && item.h === firstItem.h && item.stackable === firstItem.stackable
            );

            if (isUniformLoad) {
                const maxPossible = calculateGeometricMax(truck, firstItem);
                let fits = true;
                let reason = "Your boxes fit within the truck's grid.";
                
                if (percentWeight > 100) {
                    fits = false;
                    reason = `Weight limit exceeded: Total ${totalWeight}kg > Truck ${truck.maxWeight}kg.`;
                } else if (totalRequestedBoxes > maxPossible) {
                    fits = false;
                    reason = `Dimensional limit reached: Max ${maxPossible} units fit, you asked for ${totalRequestedBoxes}.`;
                }

                return { 
                    fits, 
                    percentVol: (totalRequestedBoxes / (maxPossible || 1)) * 100,
                    percentWeight, 
                    msg: fits ? "Load Fits Perfectly" : (percentWeight > 100 ? "Overweight" : "Space Full"),
                    totalWeight, reason, estimatedFit: maxPossible, totalBoxes: totalRequestedBoxes, mode: 'Exact Geometry'
                };
            } 

            // Mixed Load (Volume)
            let usedVolume = 0;
            const truckVol = parseFloat(truck.l) * parseFloat(truck.w) * parseFloat(truck.h);

            manifest.forEach(item => {
                const qty = parseFloat(item.qty) || 0;
                const v = parseFloat(item.l) * parseFloat(item.w) * (item.stackable ? parseFloat(item.h) : parseFloat(truck.h));
                usedVolume += v * qty;
            });

            const percentVol = (usedVolume / (truckVol * 0.90)) * 100;
            let fits = percentWeight <= 100 && percentVol <= 100;
            
            return { 
                fits, 
                percentVol, 
                percentWeight, 
                msg: fits ? "Mixed Load Fits" : "Load Exceeds Capacity", 
                totalWeight, 
                reason: percentWeight > 100 ? "Weight limit exceeded." : "Volume/Stacking limit exceeded.",
                estimatedFit: totalRequestedBoxes, totalBoxes: totalRequestedBoxes, mode: 'Volume Estimate' 
            };
        }

        // --- ACTIONS ---

        function selectTruck(truckId) {
            const truck = TRUCK_TYPES.find(t => t.id === truckId);
            if(truck) {
                state.selectedTruck = {...truck};
                state.step = 3;
                render();
            }
        }

        function handleCustomTruckSubmit(e) {
            if(e) e.preventDefault();
            const l = parseFloat(state.customTruck.l);
            const w = parseFloat(state.customTruck.w);
            const h = parseFloat(state.customTruck.h);
            const maxWeight = parseFloat(state.customTruck.maxWeight);

            if (l > 0 && w > 0 && h > 0 && maxWeight > 0) {
                state.selectedTruck = {
                    id: Date.now(),
                    name: state.customTruck.name || 'Custom Truck',
                    l, w, h, maxWeight,
                    icon: 'ðŸ“',
                    desc: 'Custom user specifications'
                };
                state.step = 3;
                render();
            } else {
                alert("Please ensure all dimensions and weight are greater than zero.");
            }
        }

        function updateCustomTruck(field, value) {
            state.customTruck[field] = value;
        }

        function updateCurrentBox(field, value) {
            state.currentBox[field] = value;
        }

        function addBox(e) {
            e.preventDefault();
            const { l, w, h, qty } = state.currentBox;
            if (l && w && h && qty) {
                state.boxManifest.push({ ...state.currentBox, id: Date.now() });
                state.currentBox = { ...state.currentBox, name: '', l: '', w: '', h: '', weight: '', qty: 1 };
                render();
            }
        }

        function removeBox(id) {
            state.boxManifest = state.boxManifest.filter(b => b.id !== id);
            render();
        }

        function handleNewPlan() {
            state.boxManifest = [];
            state.selectedTruck = null;
            state.step = 1;
            render();
        }

        function goToStep(s) {
            state.step = s;
            render();
        }

        // --- RENDER ---

        function render() {
            const app = document.getElementById('app-content');
            const resetBtn = document.getElementById('btn-header-reset');
            if (resetBtn) {
                if (state.step === 1) resetBtn.classList.add('hidden');
                else resetBtn.classList.remove('hidden');
            }

            app.innerHTML = '';

            if (state.step === 1) {
                renderStep1(app);
            } else if (state.step === 3) {
                renderStep3(app);
            } else if (state.step === 4) {
                renderStep4(app);
            }

            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function renderStep1(container) {
            container.innerHTML = `
                <div class="animate-fade-in">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Select Truck Type</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        ${TRUCK_TYPES.map(truck => `
                            <button onclick="selectTruck(${truck.id})" class="bg-white p-4 rounded-xl shadow-sm border-2 border-transparent hover:border-orange-500 transition-all text-left flex items-center gap-4 group">
                                <div class="text-3xl">${truck.icon}</div>
                                <div>
                                    <h3 class="font-bold text-gray-800">${truck.name}</h3>
                                    <div class="text-xs text-gray-500">${truck.l}x${truck.w}x${truck.h} cm (${truck.maxWeight}kg)</div>
                                </div>
                            </button>
                        `).join('')}
                    </div>

                    <div class="mt-8 bg-white p-6 rounded-2xl shadow-xl border-t-4 border-blue-500">
                        <h3 class="text-xl font-bold text-blue-800 flex items-center gap-2 mb-4">
                            <i data-lucide="settings"></i> Custom Specifications
                        </h3>
                        <form onsubmit="handleCustomTruckSubmit(event)" class="space-y-4">
                            <input type="text" placeholder="Truck/Vehicle Name" class="w-full p-2 border border-gray-300 rounded-lg outline-none" 
                                oninput="updateCustomTruck('name', this.value)" value="${state.customTruck.name}">
                            <div class="grid grid-cols-4 gap-3">
                                <div><label class="block text-[10px] font-bold text-gray-400 uppercase">L (cm)</label>
                                <input type="number" required class="w-full p-2 border rounded" oninput="updateCustomTruck('l', this.value)" value="${state.customTruck.l}"></div>
                                <div><label class="block text-[10px] font-bold text-gray-400 uppercase">W (cm)</label>
                                <input type="number" required class="w-full p-2 border rounded" oninput="updateCustomTruck('w', this.value)" value="${state.customTruck.w}"></div>
                                <div><label class="block text-[10px] font-bold text-gray-400 uppercase">H (cm)</label>
                                <input type="number" required class="w-full p-2 border rounded" oninput="updateCustomTruck('h', this.value)" value="${state.customTruck.h}"></div>
                                <div><label class="block text-[10px] font-bold text-gray-400 uppercase">Kg</label>
                                <input type="number" required class="w-full p-2 border rounded" oninput="updateCustomTruck('maxWeight', this.value)" value="${state.customTruck.maxWeight}"></div>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition-colors">Apply Custom Truck</button>
                        </form>
                    </div>
                </div>
            `;
        }

        function renderStep3(container) {
            const truck = state.selectedTruck;
            container.innerHTML = `
                <div class="animate-fade-in space-y-6">
                    <div class="bg-orange-50 border border-orange-200 p-3 rounded-lg flex justify-between items-center text-sm">
                        <span class="font-bold text-orange-800">${truck.name} (${truck.l}x${truck.w}x${truck.h})</span>
                        <button onclick="goToStep(1)" class="text-orange-600 font-bold hover:underline">Change</button>
                    </div>

                    <div class="bg-white p-5 rounded-2xl shadow-lg border-l-4 border-orange-500">
                        <h2 class="text-lg font-bold mb-4">Add Items to Load</h2>
                        <form onsubmit="addBox(event)" class="space-y-4">
                            <div class="grid grid-cols-2 gap-3">
                                <input type="text" placeholder="Item Name" class="w-full p-2 border rounded" oninput="updateCurrentBox('name', this.value)">
                                <input type="number" placeholder="Qty" required min="1" class="w-full p-2 border rounded" value="${state.currentBox.qty}" oninput="updateCurrentBox('qty', this.value)">
                            </div>
                            <div class="grid grid-cols-3 gap-3">
                                <input type="number" placeholder="L (cm)" required class="w-full p-2 border rounded" oninput="updateCurrentBox('l', this.value)">
                                <input type="number" placeholder="W (cm)" required class="w-full p-2 border rounded" oninput="updateCurrentBox('w', this.value)">
                                <input type="number" placeholder="H (cm)" required class="w-full p-2 border rounded" oninput="updateCurrentBox('h', this.value)">
                            </div>
                            <div class="flex items-center justify-between gap-4">
                                <input type="number" placeholder="Weight per unit (kg)" class="w-full p-2 border rounded" oninput="updateCurrentBox('weight', this.value)">
                                <label class="flex items-center cursor-pointer min-w-max">
                                    <div class="relative">
                                        <input type="checkbox" class="sr-only toggle-checkbox" ${state.currentBox.stackable ? 'checked' : ''} onchange="updateCurrentBox('stackable', this.checked); render();">
                                        <div class="block w-10 h-6 bg-gray-300 rounded-full transition-colors toggle-label">
                                            <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition-transform"></div>
                                        </div>
                                    </div>
                                    <span class="ml-2 text-xs font-bold text-gray-600">Stackable</span>
                                </label>
                            </div>
                            <button type="submit" class="w-full bg-gray-800 text-white font-bold py-3 rounded-xl">+ Add Item</button>
                        </form>
                    </div>

                    ${state.boxManifest.length > 0 ? `
                        <div class="space-y-2">
                            ${state.boxManifest.map((item, i) => `
                                <div class="bg-white p-3 rounded-lg border flex justify-between items-center shadow-sm">
                                    <div>
                                        <div class="font-bold text-sm">${item.name || 'Item'} x${item.qty}</div>
                                        <div class="text-[10px] text-gray-400 uppercase tracking-tighter">${item.l}x${item.w}x${item.h} | ${item.weight || 0}kg | ${item.stackable ? 'Stackable' : 'No Stack'}</div>
                                    </div>
                                    <button onclick="removeBox(${item.id})" class="text-red-400 hover:text-red-600"><i data-lucide="trash-2" width="16"></i></button>
                                </div>
                            `).join('')}
                            <button onclick="goToStep(4)" class="w-full bg-orange-600 text-white font-bold py-4 rounded-xl shadow-lg mt-4 text-lg">Calculate Final Load</button>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderStep4(container) {
            const loadStatus = calculateLoadStatus(state.selectedTruck, state.boxManifest);
            const statusColor = loadStatus.fits ? 'bg-green-600' : 'bg-red-600';

            container.innerHTML = `
                <div class="animate-fade-in space-y-6">
                    <div class="${statusColor} rounded-2xl p-6 text-white text-center shadow-xl">
                        <div class="text-3xl font-bold mb-2">${loadStatus.msg}</div>
                        <p class="text-sm opacity-90">${loadStatus.reason}</p>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white p-4 rounded-xl border">
                            <div class="text-[10px] font-bold text-gray-400 uppercase mb-2">Weight Load</div>
                            <div class="text-2xl font-bold">${Math.round(loadStatus.percentWeight)}%</div>
                            <div class="w-full bg-gray-100 h-2 rounded-full mt-2 overflow-hidden">
                                <div class="h-full bg-orange-500" style="width: ${Math.min(loadStatus.percentWeight, 100)}%"></div>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-xl border">
                            <div class="text-[10px] font-bold text-gray-400 uppercase mb-2">Space Usage</div>
                            <div class="text-2xl font-bold">${Math.round(loadStatus.percentVol)}%</div>
                            <div class="w-full bg-gray-100 h-2 rounded-full mt-2 overflow-hidden">
                                <div class="h-full bg-blue-500" style="width: ${Math.min(loadStatus.percentVol, 100)}%"></div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 text-sm text-blue-800">
                        <h4 class="font-bold flex items-center gap-2 mb-1"><i data-lucide="info" width="16"></i> Logic Note:</h4>
                        <p>${loadStatus.mode === 'Exact Geometry' ? 'Used exact grid stacking logic (best for uniform items).' : 'Used 90% volume efficiency logic (best for mixed items).'}</p>
                    </div>

                    <div class="flex flex-col gap-3">
                        <button onclick="goToStep(3)" class="w-full bg-gray-800 text-white font-bold py-3 rounded-xl">Edit Load</button>
                        <button onclick="handleNewPlan()" class="w-full bg-white text-orange-600 border border-orange-200 font-bold py-3 rounded-xl">Start New Plan</button>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>
